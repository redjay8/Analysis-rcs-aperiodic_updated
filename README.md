# Analysis-rcs-aperiodic

## Important: File and Data Structure
This project follows a specific directory structure to keep code and data organized. Below is an overview of this structure:  

Umbrella/  
├── Code/  
│   └── ... (your scripts and code files)  
└── Data/  
├── RCS02/  
│   └── ... (data files for RCS02)  
├── RCS03/  
│   └── ... (data files for RCS03)  
├── ...  
└── RCS20/
└── ... (data files for RCS20)  

All scripts were ran on the curated RCS 3 Day Sprint Data arranged by RCS number.  

### Directory Explanations

* **`Umbrella/`**: This is the root directory for the entire project. All other project-related files and folders are contained within this "Umbrella" folder.

* **`Umbrella/Code/`**:
    * **Purpose**: This folder contains all the executable code, scripts, and source files for the project.
    * **Usage**: Any scripts or programs should be run from within this `Code` directory. For example, if you have a Python script named `main_script.py`, you would typically navigate to this folder in your terminal to run it.

* **`Umbrella/Data/`**:
    * **Purpose**: This folder is designated for storing all input data, intermediate data, and output data used or generated by the project.
    * **Organization**: Data is further organized into subdirectories named `RCS02`, `RCS03`, ..., up to `RCS20`.
        * Each `RCSXX` folder (e.g., `RCS05`) corresponds to an individual `Left`, `Right` dataset for that subject.
        * Your local absolute path might be something like `/Users/xx/Library/Working/Data/RCS05 3 day sprint`.

### How to Implement and Use

1.  When you clone or download this project, ensure the `Umbrella/` folder is your main project directory.
2.  **Place Data**:
    * Ensure your data is organized into the respective `RCS02` through `RCS20` subfolders within the `Umbrella/Data/` directory.
3.  **Run Code**: Navigate to the `Umbrella/Code/` directory to execute any scripts. Ensure your scripts are written to find data in the `../Data/RCSXX/` relative path or can be configured to find the data.

# Each script explained

## Step1.m:  
Implements ProcessRCS

## Step2.m:
Performs center-aligned temporal segmentation of neural time series data with contralateral PKG (Parkinson's Kinetigraph) measurements for spectral analysis. Key processing steps include:

#### Data Integration:

Loads preprocessed RC+S neural recordings from Step 1 master data files containing multichannel time series
Retrieves contralateral PKG accelerometry scores (BK, DK, tremor metrics) to capture motor symptom severity
Implements UTC-aware timestamp alignment between neural and behavioral data streams

#### Signal Preprocessing:

Applies 4th-order Butterworth high-pass filter (1 Hz cutoff) to remove DC drift and slow physiological artifacts
Preserves pathological low-frequency oscillations (4-30 Hz) critical for Parkinsonian biomarkers
Segments only continuous data chunks >5 seconds to ensure filter stability

#### Temporal Alignment Strategy:

Centers 120-second neural windows around 30-second interpolated PKG timepoints
This 4:1 ratio balances spectral resolution (0.5 Hz with 2s Welch windows) with 2-min updating PKG data
Center alignment minimizes temporal mismatch between neural activity and motor symptoms

#### Spectral Analysis:

Computes PSDs using Welch's method (2s Hanning windows, 50% overlap) for robust spectral estimation
Parallel processing across channels for computational efficiency
Outputs include full spectral data for FOOOF decomposition and band power analyses

## Step3.ipynb:

#### Data Ingestion & Clinical State Integration: 
Loading pre-calculated PSDs and associated metadata for a specific subject and hemisphere. Then integrate clinical state information (e.g., mobile, immobile, sleep, dyskinesia levels based on PKG scores) using a 2-minute windowing approach to assign a dominant clinical state to each neural data segment.

#### Spectral Feature Extraction with FOOOF:
Core of the analysis involves using the FOOOF (Fitting Oscillations & One Over F) algorithm. For each individual PSD segment, FOOOF is applied across multiple predefined frequency ranges (e.g., 10-40Hz, 30-90Hz, 10-90Hz) using two aperiodic settings: 'fixed' (1/f) and 'knee' (1/f with a knee parameter). This separates the aperiodic (1/f-like) background activity from true periodic oscillations (peaks).
Key aperiodic parameters (offset, exponent, and knee if applicable), along with goodness-of-fit metrics (R-squared, error) and peak parameters, are extracted for each fit.
The script identifies "oscillatory humps"—broad regions of power rising above the fitted aperiodic component—and characterizes their frequency range, width, and maximum power.

#### Targeted Band Power Analysis:
To analyze specific frequency bands like beta (13-30Hz) and gamma (60-90Hz), the script first determines a channel-specific "dominant" peak frequency within these bands. This is achieved by:
            Temporarily fitting a FOOOF model to each segment to estimate its aperiodic component.
            Subtracting this aperiodic fit from the log-power spectrum to create a "flattened" spectrum.
            Identifying significant peaks in the flattened spectrum within the beta and gamma bands, based on a threshold relative to a baseline power region (e.g., 10-12Hz for beta, 55-59Hz for gamma).
            The mode of these significant peak frequencies across all segments for a given channel is deemed its dominant beta/gamma frequency.
        Finally, the power at these channel-specific dominant beta and gamma frequencies is extracted from the original (non-flattened) log-power spectra of each segment. This approach aims to capture the power of the most prominent, consistent oscillation within the band, rather than an average power that might be diluted by aperiodic shifts or broader activity.

#### Averaging & Visualization:
The script calculates and visualizes average PSDs for each recording channel, grouped by the derived clinical states. FOOOF is then run on these averaged PSDs to examine state-dependent aperiodic characteristics.
It also generates plots for individual FOOOF fits and distributions of oscillatory hump widths.

#### Master Data Compilation: 
All extracted features—including original segment metadata, clinical states, LEDD, dominant beta/gamma peak powers, detailed parameters from both 'fixed' and 'knee' FOOOF fits for each frequency band, and a "best model" selection based on R-squared—are compiled into a comprehensive master CSV file for subsequent statistical analysis.

This systematic approach allows for a detailed characterization of how both aperiodic and periodic neural activity relate to varying clinical states and medication levels. The use of FOOOF is critical for disentangling these two components of the neural power spectrum, which builds the foundation of investigating whether aperiodics offer orthogonal value over beta and gamma power.

## Step4.ipynb:

#### Comprehensive within-subject analysis:

Loads preprocessed data from the previous step, which includes neural features (aperiodic components like Exponent and Offset from FOOOF analysis, and oscillatory power in Beta and Gamma bands) and aligned PKG scores.
Crucially, we redefine granular clinical states (e.g., "Immobile", "Non-Dyskinetic Mobile", "Transitional Mobile", "Dyskinetic Mobile", "Sleep") based on thresholds applied to PKG bradykinesia (BK) and dyskinesia (DK) scores.

#### Correlation Analyses:
Calculates Spearman rank correlations (robust to non-normally distributed data common in biology) to assess relationships between neural features and PKG scores.
Bivariate correlations explore direct relationships.
Partial correlations are employed to explore any orthogonal relationship between an aperiodic feature and a PKG score while controlling for the influence of oscillatory power (Beta, Gamma). This is important as aperiodic and oscillatory activities can co-vary.

#### Predictive Modeling:
Utilizes multiple linear regression (MLR), primarily focusing on the "WideFreq" band for aperiodic parameters.
We build tiered models to predict PKG symptom scores using:
            Aperiodic features (Exponent or Offset) alone.
            Oscillatory features (Beta and Gamma power) alone.
            A combination of aperiodic and oscillatory features. This approach helps to determine the independent and combined predictive utility of different neural signal components.

#### Data Export:
We prepare and saves a final, consolidated data table containing selected raw and derived metrics per time window, channel, and frequency band. This table is formatted for subsequent cross-subject analyses.


## Suggested Mini-Project: Exploring Aperiodic Features Across Movement States

This section outlines a potential mini-project that can leverage the existing codebase and foundational analysis to explore a specific research question. It is designed to facilitate deeper understanding of the data and methods.

### Objective

A potential research question to explore is:
*   "How might the correlation directions and strengths between aperiodic features (e.g., exponent, offset) and granular Parkinson's symptoms (e.g., bradykinesia, dyskinesia, tremor) vary across different, defined movement states (e.g., immobile, non-dyskinetic mobile, dyskinetic mobile)?"

This question aligns with iterative discussions regarding the nuanced relationship between aperiodic metrics and motor symptoms.

### Rationale

This mini-project can serve as an excellent opportunity for someone new to the project or pipeline to:
*   Become familiar with the existing data processing and analysis scripts.
*   Gain hands-on experience by applying established methods to a well-defined, bounded question.
*   Build directly upon the data and scripts already established, facilitating knowledge transfer.
*   Potentially generate an initial, tangible contribution to the broader research goals.

### Potential Approach & Tasks

Guidance can be drawn from the existing `step4.ipynb` notebook and prior presentations. The following steps outline a possible approach:

1.  **Understand Movement State Definitions:**
    *   Familiarize oneself with the implementation of Movement States (e.g., Sleep, Immobile, Non-Dyskinetic Mobile, Transitional Mobile, Dyskinetic Mobile).
    *   These states are defined and implemented at the beginning of the `step4.ipynb` notebook (refer to Cell 3 for point-by-point definitions). This implementation is consistent with prior work, such as "Motor network gamma oscillations in chronic home recordings predict dyskinesia in Parkinson's disease" (PMID: 38195196).

2.  **Adapt Existing Analysis Code:**
    *   The existing correlation and stratification code within `step4.ipynb` (e.g., logic similar to that in Cell 5, which performs state-specific correlations) can be modified.
    *   This adaptation would focus on analyzing aperiodic-symptom relationships specifically within each of the pre-defined movement states.

3.  **Analyze and Compare Results:**
    *   The analysis can involve quantifying and comparing correlation strengths and directions across the different movement states.
    *   Generate proper visualizations to clearly present the findings from the state-specific analyses.
