# Analysis-rcs-aperiodic

## Important: File and Data Structure
This project follows a specific directory structure to keep code and data organized. Below is an overview of this structure:  

Umbrella/  
├── Code/  
│   └── ... (your scripts and code files)  
└── Data/  
├── RCS02/  
│   └── ... (data files for RCS02)  
├── RCS03/  
│   └── ... (data files for RCS03)  
├── ...  
└── RCS20/  
└── ... (data files for RCS20)  

All scripts were ran on the curated RCS 3 Day Sprint Data arranged by RCS number.  

### Directory Explanations

* **`Umbrella/`**: This is the root directory for the entire project. All other project-related files and folders are contained within this "Umbrella" folder.

* **`Umbrella/Code/`**:
    * **Purpose**: This folder contains all the executable code, scripts, and source files for the project.
    * **Usage**: Any scripts or programs should be run from within this `Code` directory. For example, if you have a Python script named `main_script.py`, you would typically navigate to this folder in your terminal to run it.

* **`Umbrella/Data/`**:
    * **Purpose**: This folder is designated for storing all input data, intermediate data, and output data used or generated by the project.
    * **Organization**: Data is further organized into subdirectories named `RCS02`, `RCS03`, ..., up to `RCS20`.
        * Each `RCSXX` folder (e.g., `RCS05`) corresponds to an individual `Left`, `Right` dataset for that subject.
        * Your local absolute path might be something like `/Users/xx/Library/Working/Data/RCS05 3 day sprint`.

### How to Implement and Use

1.  When you clone or download this project, ensure the `Umbrella/` folder is your main project directory.
2.  **Place Data**:
    * Ensure your data is organized into the respective `RCS02` through `RCS20` subfolders within the `Umbrella/Data/` directory.
3.  **Run Code**: Navigate to the `Umbrella/Code/` directory to execute any scripts. Ensure your scripts are written to find data in the `../Data/RCSXX/` relative path or can be configured to find the data.


# Pipeline Architecture
## Step 1: Data Ingestion and Preprocessing (Step1_github.m)
Purpose: Consolidates raw RC+S neural recordings across multiple sessions into a unified data structure.  
Key Operations:  

Implements ProcessRCS toolbox for JSON data parsing  
Handles variable sampling rates with robust type conversion  
Generates combined data tables with aligned timestamps  
Creates quality control visualizations for each recording session  

Output: Master .mat file containing all neural time series data with metadata  

## Step 2: Signal Processing and Temporal Alignment (Step2_github.m)  
Purpose: Performs temporal segmentation and spectral analysis while aligning neural data with behavioral measurements.  
Key Features:  

Signal Conditioning:  

4th-order Butterworth high-pass filter (1 Hz cutoff) to remove DC drift  
Preserves pathological low-frequency oscillations (4-30 Hz)  
Processes only continuous segments >5 seconds for filter stability  

Temporal Alignment:  

Centers 120-second neural windows on 30-second interpolated PKG timepoints  
Achieves 0.5 Hz spectral resolution with 2-second Welch windows  
Minimizes temporal mismatch between neural and behavioral data  

Spectral Analysis:  

Welch's method with Hanning windows (50% overlap)  
Parallel processing across channels for efficiency  
Outputs full spectral arrays for subsequent FOOOF decomposition  

Output: Aligned PSD segments with PKG scores in CSV format  

## Step 3: Spectral Decomposition and Feature Extraction (step3_github.ipynb)  
Purpose: Separates aperiodic and oscillatory components of neural power spectra and extracts clinically relevant features.  
Core Algorithms:

FOOOF Analysis:

Tests both 'fixed' (1/f) and 'knee' models across multiple frequency ranges
Extracts aperiodic parameters: offset, exponent, and knee (when applicable)
Identifies oscillatory "humps" above the aperiodic background
Selects best model based on R² criteria


Clinical State Assignment:

Point-by-point classification based on PKG thresholds:

Sleep: BK ≥ 80
Immobile: 26 < BK < 80 AND DK < 7
Mobile states: BK ≤ 26 OR DK ≥ 7 (subdivided by DK percentiles)


No temporal windowing to avoid state smoothing artifacts


Band-Specific Power Analysis:

Identifies channel-specific dominant frequencies in beta (13-30 Hz) and gamma (60-90 Hz) bands
Uses flattened spectra (aperiodic-removed) for robust peak detection
Extracts power at dominant frequencies from original spectra



Output: Master CSV with all spectral features, clinical states, and metadata
Step 4: Statistical Analysis and Visualization (step4_github_fix.ipynb)
Purpose: Comprehensive within-subject statistical analysis to evaluate relationships between neural biomarkers and motor symptoms.
Analysis Framework:

Correlation Analyses:

Spearman correlations between neural features and PKG scores
Partial correlations controlling for oscillatory confounds
FDR correction across all tests to control false discovery rate


Predictive Modeling:

Multiple linear regression with tiered model comparison
Likelihood ratio tests for model selection
Separate analyses for global and state-specific relationships


Visualization Suite:

Dot-and-whisker plots for regression coefficients with 95% CIs
Orthogonal variance explained (ΔR²) visualizations
State-stratified scatter plots with bootstrapped median CIs



Output: Statistical results tables and publication-ready figures
Requirements
Software Dependencies

MATLAB R2020a or later
Python 3.8+ with the following packages:

fooof (v1.0.0+)
pandas, numpy, scipy
statsmodels, pingouin
matplotlib, seaborn
scikit-posthocs



Data Requirements

RC+S neural recordings in JSON format
PKG accelerometry CSV files with BK, DK, and tremor scores
Minimum 120 seconds of continuous neural data per segment

Usage

Configure paths in each script header to point to your data directories
Run scripts sequentially:
bashmatlab -batch "run('Step1_github.m')"
matlab -batch "run('Step2_github.m')"
jupyter notebook step3_github.ipynb
jupyter notebook step4_github_fix.ipynb

Review outputs in the generated Working/ directory structure

Output Structure
Working/
├── step1_processed_data_multi_session/
├── step2_preprocessed_data_120s_neural_aligned_*/
├── step3_fooof_results_neural_pkg_aligned/
└── step4_within_subject/
    ├── Correlation_CSVs/
    ├── MultipleLinearRegression_Results/
    └── Visualization_Plots/


## Suggested Mini-Project: Exploring Aperiodic Features Across Movement States

This section outlines a potential mini-project that can leverage the existing codebase and foundational analysis to explore a specific follow-up question. It is designed to facilitate deeper understanding of the data and methods.

### Objective

A potential research question:  
*   "How might the correlation directions and strengths between aperiodic features (e.g., exponent, offset) and granular Parkinson's symptoms (e.g., bradykinesia, dyskinesia, tremor) vary across different, defined movement states (e.g., immobile, non-dyskinetic mobile, dyskinetic mobile)?"  

This question aligns with iterative discussions regarding the nuanced relationship between aperiodic metrics and motor symptoms.  

### Potential Approach & Tasks

Guidance can be drawn from the existing `step4.ipynb` notebook and prior presentations. The following steps outline a possible approach:

1.  **Understand Movement State Definitions:**
    *   Get familiarized with the implementation of Movement States (e.g., Sleep, Immobile, Non-Dyskinetic Mobile, Transitional Mobile, Dyskinetic Mobile).
    *   These states are defined and implemented at the beginning of the `step4.ipynb` notebook (refer to Cell 3 for point-by-point definitions). This implementation is consistent with prior work, such as "Motor network gamma oscillations in chronic home recordings predict dyskinesia in Parkinson's disease" (PMID: 38195196).

2.  **Adapt Existing Analysis Code:**
    *   The existing correlation and stratification code within `step4.ipynb` (e.g., logic similar to that in Cell 5, which performs state-specific correlations) can be modified.
    *   This adaptation would focus on analyzing aperiodic-symptom relationships specifically within each of the pre-defined movement states.

3.  **Analyze and Compare Results:**
    *   The analysis can involve quantifying and comparing correlation strengths and directions across the different movement states.
    *   Generate proper visualizations to clearly present the findings from the state-specific analyses.

### Further Steps  

Further characterization of the exponent and whether the offset provides predictive value in the same direction, particularly examining orthogonal predictive power within predefined states.  

Exploratory analysis of the stimulation-on states, extending beyond the current 72h of naturalistic recordings in each patient. How does stimulation affect the aperiodic exponent?

